{{ 
    config(
        materialized='table', 
        alias='FACT_MEMBER_STATUS',
	tags=["fact"]
    ) 
}}

WITH LAST_PICK_DATE_RYP AS (
    SELECT DISTINCT
        AE.MEMBER_EMAIL,
        AE.SOURCE,
        MAX(PICK_DATE) AS LPD

    FROM {{ ref('fact_active_entries') }} AE
    WHERE MEMBER_EMAIL NOT LIKE ''
    GROUP BY MEMBER_EMAIL, SOURCE
),

DAYS_SINCE_LAST_PICK_RYP AS (
SELECT 
    MEMBER_EMAIL,
    LPD AS LAST_PICK_DATE,
    DATEDIFF(DAY, LPD, CURRENT_DATE) AS DAYS_SINCE_LAST_PICK,
    SOURCE
FROM LAST_PICK_DATE_RYP
ORDER BY LPD DESC
),

FINAL_RYP AS (
    SELECT 
        DAYS_SINCE_LAST_PICK_RYP.MEMBER_EMAIL,
        M.DATE_TIME_CREATED::DATE AS ACCOUNT_CREATED_AT,
        LAST_PICK_DATE,
        DAYS_SINCE_LAST_PICK,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN DATEADD(DAY, 365, LAST_PICK_DATE) END AS CHURNED_DATE,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN (365 - DAYS_SINCE_LAST_PICK) END AS DAYS_UNTIL_CHURN,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN 1 ELSE 0 END AS IS_ACTIVE,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN 1 ELSE 0 END AS IS_CHURNED,
        DAYS_SINCE_LAST_PICK_RYP.SOURCE
    
    FROM DAYS_SINCE_LAST_PICK_RYP
    JOIN {{ ref('stg_ryp_members') }} M ON DAYS_SINCE_LAST_PICK_RYP.MEMBER_EMAIL = M.MEMBER_EMAIL AND DAYS_SINCE_LAST_PICK_RYP.SOURCE = M.SOURCE
    
),

FINAL_OFP AS (
    SELECT 
        DAYS_SINCE_LAST_PICK_RYP.MEMBER_EMAIL,
        M.DATE_TIME_CREATED::DATE AS ACCOUNT_CREATED_AT,
        LAST_PICK_DATE,
        DAYS_SINCE_LAST_PICK,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN DATEADD(DAY, 365, LAST_PICK_DATE) END AS CHURNED_DATE,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN (365 - DAYS_SINCE_LAST_PICK) END AS DAYS_UNTIL_CHURN,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN 1 ELSE 0 END AS IS_ACTIVE,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN 1 ELSE 0 END AS IS_CHURNED,
        DAYS_SINCE_LAST_PICK_RYP.SOURCE
    
    FROM DAYS_SINCE_LAST_PICK_RYP
    JOIN {{ ref('stg_ofp_members') }} M ON DAYS_SINCE_LAST_PICK_RYP.MEMBER_EMAIL = M.MEMBER_EMAIL AND DAYS_SINCE_LAST_PICK_RYP.SOURCE = M.SOURCE
    
)


SELECT * FROM FINAL_OFP

UNION

SELECT * FROM FINAL_RYP

ORDER BY MEMBER_EMAIL