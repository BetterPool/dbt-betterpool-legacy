{{ 
    config(
        materialized='table', 
        alias='FACT_LEAGUE_STARTS',
	tags=["fact"]
    ) 
}}

WITH LEAGUES AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUES') }}
    WHERE CONFIRMED = TRUE
),

LEAGUE_TYPES AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUE_TYPES') }}
),

LEAGUE_CATEGORY AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUE_CATEGORIES') }}
),

RYP_FINAL AS (
    SELECT
        LEAGUES.LEAGUE_START_DATE::DATE AS LEAGUE_START_DATE,
	LEAGUE_TYPES.DESCRIPTION AS LEAGUE_TYPE,
        COALESCE(LEAGUE_CATEGORY.DATASOURCE_NAME, 'UNKNOWN') AS LEAGUE_CATEGORY,
        LEAGUES.LEAGUE_ID AS LEAGUE_ID,
        'RYP' AS SOURCE
    FROM LEAGUES
    LEFT JOIN
        LEAGUE_TYPES ON LEAGUES.LEAGUE_TYPE_ID = LEAGUE_TYPES.LEAGUE_TYPE_ID
    LEFT JOIN
        LEAGUE_CATEGORY ON
            LEAGUE_TYPES.LEAGUE_CATEGORY_ID = LEAGUE_CATEGORY.LEAGUE_CATEGORY_ID
    ORDER BY LEAGUES.LEAGUE_START_DATE::DATE DESC
),

OFP_FINAL AS (
    SELECT
        DATE_CREATED::DATE AS LEAGUE_START_DATE,
	LEAGUE_TYPE,
        LEAGUE_CATEGORY AS LEAGUE_CATEGORY,
        POOL_ID AS LEAGUE_ID,
        'OFP' AS SOURCE
    FROM {{ ref('stg_ofp_pools') }} 
)

SELECT * FROM OFP_FINAL
UNION
SELECT * FROM RYP_FINAL
