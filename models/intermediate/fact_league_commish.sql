{{ 
    config(
        materialized='table', 
        alias='FACT_LEAGUE_COMMISH',
	tags=["fact"]
    ) 
}}

WITH FINAL AS (
    SELECT
        M.MEMBER_ID AS COMMISH_ID,
        M.MEMBER_EMAIL AS COMMISH_EMAIL,
	L.LEAGUE_ID AS LEAGUE_ID,
	LEAGUE_CATEGORY,
	LEAGUE_TYPE,
        L.LEAGUE_START_DATE AS LEAGUE_CREATED_DATE,
	ROW_NUMBER() OVER (PARTITION BY M.MEMBER_EMAIL ORDER BY L.LEAGUE_START_DATE) AS LEAGUE_CREATED_SEQUENCE,
        'RYP' AS SOURCE
    FROM {{ ref('stg_ryp_members') }} M
            JOIN {{ ref('stg_ryp_teams') }} T ON M.MEMBER_ID = T.MEMBER_ID
            JOIN {{ ref('stg_ryp_leagues') }} L ON T.LEAGUE_ID = L.LEAGUE_ID
	WHERE T.LEAGUE_COMMISH = TRUE

    UNION 
    
    SELECT
        POOLMASTER_ID AS COMMISH_ID,
        MEMBER_EMAIL AS MEMBER_EMAIL,
	POOL_ID AS LEAGUE_ID,
	LEAGUE_CATEGORY,
	LEAGUE_TYPE,
        P.DATE_CREATED::DATE AS LEAGUE_CREATED_DATE,
	ROW_NUMBER() OVER (PARTITION BY M.MEMBER_EMAIL ORDER BY P.DATE_CREATED) AS ORDER_CREATED,
        'OFP' AS SOURCE
        
    FROM {{ ref('stg_ofp_pools') }} P
        JOIN {{ ref('stg_ofp_members') }} M ON P.POOLMASTER_ID = M.MEMBER_ID
)

SELECT * FROM FINAL
