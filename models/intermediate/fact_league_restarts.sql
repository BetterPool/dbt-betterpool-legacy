{{ 
    config(
        materialized='table', 
        alias='FACT_LEAGUE_RESTARTS',
	tags=["fact"]
    ) 
}}

WITH LEAGUES AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUES') }}
    WHERE CONFIRMED = TRUE
 ),

LEAGUE_TYPES AS  (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUE_TYPES') }} 
), 

LEAGUE_CATEGORY AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUE_CATEGORIES') }} 
), 

LEAGUE_RESET_STATUS AS (
    SELECT *
    FROM {{ source('RYP_RUNYOURPOOL_DBO', 'LEAGUE_RESET_STATUS') }} 
    WHERE _FIVETRAN_DELETED = FALSE 
),
FINAL_RYP AS (
SELECT 
    L.LEAGUE_ID AS LEAGUE_ID,
    LR.RESET_DATE::DATE AS LEAGUE_RESET_DATE,
    IFNULL(LC.DATASOURCE_NAME,'UNKNOWN') AS LEAGUE_CATEGORY,
    LT.DESCRIPTION AS LEAGUE_TYPE,
    'RYP' AS SOURCE
	
FROM LEAGUES L
	JOIN LEAGUE_RESET_STATUS LR ON L.LEAGUE_ID = LR.LEAGUE_ID
	LEFT JOIN LEAGUE_TYPES LT ON L.LEAGUE_TYPE_ID = LT.LEAGUE_TYPE_ID
	LEFT JOIN LEAGUE_CATEGORY LC ON LT.LEAGUE_CATEGORY_ID = LC.LEAGUE_CATEGORY_ID 
	ORDER BY LR.RESET_DATE::DATE DESC
),
FINAL_OFP AS (
    SELECT DISTINCT 
        LEAGUE_ID,
        TRANSACTION_DATE AS LEAGUE_RESET_DATE,
        LEAGUE_CATEGORY,
	LEAGUE_TYPE,
        SOURCE
    FROM {{ ref('stg_ofp_transactions_final') }}
)

SELECT * FROM FINAL_RYP
UNION
SELECT * FROM FINAL_OFP
