{{ 
    config(
        materialized='table', 
        alias='FACT_MEMBER_STATUS_BY_LEAGUE_CATEGORY',
	tags=["fact"]
    ) 
}}

WITH LAST_PICK_DATE AS (
    SELECT DISTINCT
        AE.MEMBER_EMAIL,
        AE.LEAGUE_CATEGORY,
	    AE.SOURCE,
        MAX(PICK_DATE) AS LPD

    FROM {{ ref('fact_active_entries') }} AE
    WHERE MEMBER_EMAIL NOT LIKE ''
    GROUP BY MEMBER_EMAIL, LEAGUE_CATEGORY, SOURCE
),

DAYS_SINCE_LAST_PICK AS (
SELECT 
    MEMBER_EMAIL,
    LEAGUE_CATEGORY,
    LPD AS LAST_PICK_DATE,
    DATEDIFF(DAY, LPD, CURRENT_DATE) AS DAYS_SINCE_LAST_PICK,
    SOURCE
FROM LAST_PICK_DATE
ORDER BY LPD DESC
),

FINAL AS (
    SELECT 
        MEMBER_EMAIL,
        LEAGUE_CATEGORY,
        LAST_PICK_DATE,
        DAYS_SINCE_LAST_PICK,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN DATEADD(DAY, 365, LAST_PICK_DATE) END AS CHURNED_DATE,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN (365 - DAYS_SINCE_LAST_PICK) END AS DAYS_UNTIL_CHURN,
        CASE WHEN DAYS_SINCE_LAST_PICK < 365 THEN 1 ELSE 0 END AS IS_ACTIVE,
        CASE WHEN DAYS_SINCE_LAST_PICK >= 365 THEN 1 ELSE 0 END AS IS_CHURNED,
        SOURCE
    
    FROM DAYS_SINCE_LAST_PICK
)

SELECT * FROM FINAL
ORDER BY MEMBER_EMAIL